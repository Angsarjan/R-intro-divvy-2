---
title: "Introduction to R for data analysis"
author: Peter Carbonetto
output:
  beamer_presentation:
    template: beamer.tex
    keep_tex: false
---

```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,fig.align = "center",
                      results = "hide", fig.show = "hide", message = FALSE,
		      warning = FALSE)
```

Aims of workshop
================

*Add workshop aims here.*

Our project: analyze 2016 & 2017 Divvy data
===========================================

*Describe the Divvy data analysis project and aims.*

It's your choice
================

Your may choose to...

+ Use R on your laptop.

+ Use RStudio on your laptop.

+ Use R or RStudio (Desktop or Server) on the RCC cluster.

+ Pair up with your neighbour.

+ Follow what I do on the projector.

**Note:** If you use the RCC cluster I'm assuming you know how to set
up an interactive computing session with appropriate amount of time
and memory, load R or RStudio, and display graphics (e.g., using
ThinLinc). *I can help with this.*

Software we will use today
==========================

1. R

2. R packages `data.table` and `ggplot2`.

3. RStudio (optional).

**Note:** I'm assuming you have already installed R and/or RStudio on
your laptop, or you are using the RCC cluster.

Outline of workshop
===================

*Add outline here.*

Outline of initial setup
========================

*Add outline of initial setup here.*

Initial setup
=============

+ WiFi

+ Power outlets

+ YubiKeys

+ Pace, questions (e.g., keyboard shortcuts).

Download or "clone" git repository
==================================

The first step is to download the workshop packet onto your computer
or onto the RCC cluster. Go to:

+ [**github.com/rcc-uchicago/R-intro-divvy-2**][github-repo]

To download, click green **"Clone or download"** button.

Or, if you have **git**, you can run this command:

```{bash download-repo, eval=FALSE}
git clone https://github.com/rcc-uchicago/
  R-intro-divvy-2.git
```

(Note the URL in the git command should not contain any spaces.)

What's in the workshop packet
=============================

```
R-intro-divvy-2
  /analysis # Scripts implementing data analyses.
  /code     # Additional R code used in analyses.
  /data     # Original ("raw") data.
  /docs     # Additional workshop materials.
  /output   # Processed data & results files.
```

Open the slides on your computer
================================

The PDF is useful for copying & pasting code from the slides.

+ The PDF is in the [**"docs"**](../docs) folder of the workshop packet.

+ You can also view the PDF by clicking the **"docs"** item in the file
  listing on the GitHub webpage.

Download the Divvy data
=======================

+ Disk space required: at least **2 GB**.

+ Download the 2016 & 2017 data files from here:

    + [**www.divvybikes.com/system-data**][divvy-data]

+ Download them to the [**"data"**](../data) folder.

+ You should have 4 ZIP files:

    ```
    Divvy_Trips_2016_Q1Q2.zip
    Divvy_Trips_2016_Q3Q4.zip
    Divvy_Trips_2017_Q1Q2.zip
    Divvy_Trips_2017_Q3Q4.zip
    ```

+ Unzip all of these files.

+ After unziping these files, you should have **15** CSV files.

[github-repo]: https://github.com/rcc-uchicago/R-intro-divvy-2
[divvy-data]: https://www.divvybikes.com/system-data

Set up your R environment
=========================

+ Launch R or RStudio.

+ *We will run all the code from the **"analysis"** folder*.

+ To change your working directory:

    + In R, use `getwd()` function.

    + In RStudio, select **Session > Set Working Directory > Choose
      Directory...`**

Before continuing, check your working directory:

```{r check-wd}
getwd()  # Should be .../analysis
```

Run `sessionInfo()`
===================

Check the version of R that you are using:

```{r check-version}
sessionInfo()
```

If you are using an older version of R (version 3.2 or earlier), you
should upgrade to the latest version. *Some of the examples may not
work in older versions of R.*

Check your R environment
========================

The R environment is where all variables and functions are stored and
accessed. Your R environment should be empty:

```{r check-env}
ls()
```

If you do see names of objects listed, it means your environment is
not empty, and you should restart R with a clean environment. (In
RStudio, go to **Session > Restart R**.)

Create a file to keep track of your analysis code
=================================================

+ In RStudio, select **File > R Script**.

+ Alternatively, use your favourite editor (emacs, vim, Atom, *etc*).

+ Add some comments to the tile to remind yourself what this file is
  for, e.g.,

    ```
    # R code I used to analyze Divvy data
	# during RCC workshop on May 1, 2018.
    ```

+ Save the file in the [**"analysis"**](../analysis) folder.
  Name the file whatever you'd like (e.g., `myanalysis.R`).

+ At this point, we are ready to start our analysis of the Divvy data.

Outline of workshop
===================

*Add outline of workshop here.*

Import the station data into R
==============================

Load the most recent available station data into an R "data frame":

```{r read-station-data}
stations <-
  read.csv("../data/Divvy_Stations_2017_Q3Q4.csv",
           stringsAsFactors = FALSE)
```

This creates a new "data frame" object in your environment:

```{r inspect-station-data-1}
ls()
class(stations)
```

What does `read.csv` do, and what is a "data frame"? We can find the
answers by running

```{r help-readcsv-dataframe, eval=FALSE}
help(read.csv)
help(data.frame)
```

Inspect the Divvy station data
==============================

Run these commands to inspect the station data:

```{r inspect-station-data}
nrow(stations)
ncol(stations)
head(stations)
tail(stations)
stations[1:6,]
summary(stations)
```

*What do we learn about the station data from running these
commands? Did we reveal any issues with these data?*

Take a closer look at the "dpcapacity" column
=============================================

Run these commands to take a closer look at the "dpcapacity" column:

```{r inspect-dpcapacity-data-1}
x <- stations$dpcapacity
class(x)
summary(x)
table(x)
quantile(x,seq(0,1,0.1))
```

*What did we learn about the Divvy stations from running these
commands?*

Take an even closer look at dpcapacity data
===========================================

It is interesting that a few of the Divvy bike stations are much
larger than the others, and some have no docks. Where are these
stations?

```{r inspect-dpcapacity-data-2}
subset(stations,dpcapacity == 0)
subset(stations,dpcapacity >= 40)
```

Alternatively, we can sort the table rows and inspect the top and
bottom rows:

```{r inspect-dpcapcity-data-3}
rows <- order(stations$dpcapacity,decreasing=TRUE)
stations <- stations[rows,]
head(stations)
tail(stations)
```

Take a closer look at the "city" column
=======================================

Above we inspected *numeric* data. How can we inspect non-numeric data
in R?

```{r inspect-city-data-1}
x <- stations$city
class(x)
summary(x)
```

Unfortunately, the summary is not very useful here. The key is to
convert the "city" column to a "factor" (a categorical variable):

```{r inspect-city-data-2}
x <- factor(stations$city)
class(x)
summary(x)
```

*What did we learn about the Divvy stations from running these
commands? What issue did we discover in the station data? How could we
fix this issue?*

Improving the "city" column
===========================

Let's fix this problem:

```{r revise-city-data-1}
rows <- which(stations$city == "Chicago ")
length(rows)
stations[rows,"city"] <- "Chicago"
```

We also observed that the "city" column is more useful if it is a
factor, so let's convert it to a factor:

```{r revise-city-data-2}
stations <- transform(stations,city = factor(city))
summary(stations)
```

Import the Divvy trip data into R
=================================

Previously, we used the `read.csv` function to import some of the
station data into R. Let's now use the same function to load the most
recent available trip data:

```{r read-trip-data}
trips <-
  read.csv("../data/Divvy_Trips_2017_Q4.csv",
           stringsAsFactors = FALSE)
```

You may find that this command look longer to run than
before. Consider that the trips data is much larger:

```{r trip-data-size}
nrow(trips)
ncol(trips)
```

This gives an opportunity to demonstrate a much faster method from the
`data.table` package for importing large data sets.

Import Divvy trip data using `fread`
====================================

Install the **data.table** package from CRAN:

```{r install-data-table, eval=FALSE}
install.packages("data.table")
```

Load the package funtions into your environment:

```{r load-data-table}
library(data.table)
```

Now let's see how well the `fread` function performs:

```{r read-trip-data-better-1}
trips <- fread("../data/Divvy_Trips_2017_Q4.csv",
               stringsAsFactors = FALSE)
```

One annoying feature of `fread` is that it uses its own "data.table"
class, so we need to convert it to a data frame object if we want to
use it like other data frames:

```{r read-trip-data-better-2}
class(trips) <- "data.frame"
```

More about packages in R
========================

+ CRAN is the official package source (cran.r-project.org).

+ Other major sources: Bioconductor, GitHub.

+ *What packages are already installed?*
  `rownames(installed.packages())`.

+ *Where are the packages?* `.libPaths()`.

+ *How to learn more about a package?* `help(package = data.table)`.

+ "Vignettes" are also a great way to learn about a package, e.g.,
  `vignette("datatable-intro")`

A first glance at the trips data
================================

Let's use some of the same commands as before to quickly get an
overview of the trip data:

```{r inspect-trip-data-1}
nrow(trips)
ncol(trips)
head(trips)
summary(trips)
```

Unfortunately, the summary command isn't particularly informative for
many of the columns. We have the same problem as before—we should
convert some of the columns to factors.

Convert some columns to factors
===============================

Let's start by converting the "station" columns to factors:

```{r inspect-trip-data-2}
trips <- transform(trips,
  from_station_name = factor(from_station_name),
  to_station_name = factor(to_station_name))
summary(trips)
```

The summary is now more informative. However, this is a better way to
convert the "station" columns to factors:

```{r inspect-trip-data-3}
x     <- stations$name
trips <- transform(trips,
  from_station_name = factor(from_station_name,x),
  to_station_name = factor(to_station_name,x))
```

*Why is second approach better?*

Working with dates and times
============================

Like the categorical variables (the "factors"), the summaries for the
dates and times aren't particularly useful. Working with dates & times
iin R is more complicated, so for now I will only point out that the
`lubridate` package has lots of useful functions for working with
dates & times.

Take a closer look at the trips from U of C
===========================================

Having imported and prepared the data in R, let's take a close look
at the trip data departing from the central Divvy station the
University of Chicago campus.

```{r get-uc-trips}
uofstn   <- "University Ave & 57th St"
uc.trips <-
  subset(trips,from_station_name == uofstn)
nrow(uc.trips)
```

How do the ages of the riders at U of C compare to citywide riders?

```{r inspect-uc-trips-1}
summary(uc.trips$birthyear)
summary(trips$birthyear)
```

*What are the NA's?*

Inspect further the U of C trip data
====================================

It is also fun to look at the final destinations of all the riders who
started from 57th & University:

```{r inspect-uc-trips-2}
counts <- table(uc.trips$to_station_name)
counts <- counts[counts > 0]
sort(counts,decreasing = TRUE)
```

What is the destination for most riders? How many times did people
bike all the way to Millenium Park in Fall 2017?

Save your code & session state
==============================

It is important to periodically save your code and save the state of
your R environment just in case you accidentally quit or the program
crashes; e.g.,

```{r save-session-1, eval=FALSE}
save.image("../output/myanalysis.RData")
```

Outline of workshop
===================

*Add outline here.*

Where to go from here
=====================

*Add info here.*

